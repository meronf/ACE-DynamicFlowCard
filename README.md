# ACE Dynamic Flow Card

## Summary

A SharePoint Framework (SPFx) Adaptive Card Extension (ACE) that integrates with Power Automate flows to display dynamic HTML content. This solution demonstrates how to securely call Power Automate flows from Viva Connections cards using authentication patterns with Bearer tokens.

The card allows users to configure a Power Automate flow URL and custom prompts through the property pane, then displays the HTML response from the flow in a QuickView. Perfect for creating dynamic content cards that can show personalized information, reports, or interactive content generated by AI & Power Automate.

![SPFx](https://img.shields.io/badge/SPFx-1.20.0-green.svg)
![Power Automate](https://img.shields.io/badge/Power%20Automate-Integration-blue.svg)
![Authentication](https://img.shields.io/badge/Authentication-Bearer%20Token-orange.svg)

## Key Features

- âœ… **Secure Authentication**: Uses Bearer token approach with AadTokenProvider
- âœ… **Dynamic Content**: Displays HTML content returned from Power Automate flows
- âœ… **Configurable Prompts**: Allows users to configure custom prompts sent to flows
- âœ… **Error Handling**: Comprehensive error handling with fallback authentication methods
- âœ… **JWT Token Decoding**: Extracts tenant information for enhanced security
- âœ… **Real-time Loading States**: Visual feedback during flow execution
- âœ… **Responsive Design**: Works seamlessly in Viva Connections

## Used SharePoint Framework Version

![version](https://img.shields.io/badge/version-1.20.0-green.svg)

## Applies to

- [SharePoint Framework](https://aka.ms/spfx)
- [Microsoft 365 tenant](https://docs.microsoft.com/en-us/sharepoint/dev/spfx/set-up-your-developer-tenant)
- [Viva Connections](https://docs.microsoft.com/en-us/viva/connections/)
- [Power Automate](https://docs.microsoft.com/en-us/power-automate/)

> Get your own free development tenant by subscribing to [Microsoft 365 developer program](http://aka.ms/o365devprogram)

## Prerequisites

- SharePoint Framework development environment
- Power Automate premium license (for authenticated flows)
- SharePoint Admin rights (for API permission approval)
- Node.js 18+ and npm

## Architecture

### Authentication Flow
```
ACE Card â†’ AadTokenProvider â†’ Bearer Token â†’ Power Automate Flow â†’ HTML Response â†’ QuickView
```

### Data Flow
```json
{
  "userId": "user@domain.com",
  "userEmail": "user@domain.com", 
  "displayName": "User Name",
  "siteUrl": "https://tenant.sharepoint.com/sites/site",
  "timestamp": "2025-09-15T11:30:00.000Z",
  "requestId": "abc123def",
  "tenantId": "c3bdda97-e8dc-48ba-a1c0-a57673aa1dac",
  "prompt": "User-configured prompt text"
}
```

## Solution

| Solution               | Author(s)                                               |
| ---------------------- | ------------------------------------------------------- |
| ace-dynamic-flow-card  | [Meron Fridman - Principal Consultant - Microsoft ISD](https://www.microsoft.com/en-us/industry?activetab=pillars%3aprimaryr11?activetab=pillars%3aprimaryr11)          |

## Version History

| Version | Date             | Comments                                    |
| ------- | ---------------- | ------------------------------------------- |
| 1.0     | September 2025   | Initial release with Bearer token auth     |
| 0.9     | September 2025   | Added prompt configuration support          |
| 0.8     | September 2025   | Implemented PnP authentication pattern     |
| 0.5     | September 2025   | Basic ACE structure and Power Automate integration |

## Configuration

### 1. API Permissions Setup

Add the following to your `package-solution.json`:

```json
{
  "solution": {
    "webApiPermissionRequests": [
      {
        "resource": "Microsoft Flow Service",
        "scope": "User"
      }
    ]
  }
}
```

### 2. SharePoint Admin Approval

1. Deploy the solution to your SharePoint App Catalog
2. Go to SharePoint Admin Center
3. Navigate to **Advanced** â†’ **API Access**
4. Approve the "Microsoft Flow Service" permission request

### 3. Power Automate Flow Setup

#### Import the Pre-built Flow Solution

1. **Download the Flow Solution**:
   - Navigate to the `Flow/` folder in this repository
   - Download the `ACEContentFlow_1_0_0_1.zip` file

2. **Import to Power Automate**:
   - Go to [Power Automate](https://make.powerautomate.com)
   - Click **"Solutions"** in the left navigation
   - Click **"Import solution"**
   - Click **"Browse"** and select the `ACEContentFlow_1_0_0_1.zip` file
   - Click **"Next"** and review the solution contents
   - Configure any required connections if prompted
   - Click **"Import"** to complete the process

3. **Configure the Imported Flow**:
   - After import, go to **"Solutions"** â†’ **"ACE Content Flow"** (or the imported solution name)
   - Click on the flow to open it
   - Click **"Edit"** to modify the flow
   - Review the **"When an HTTP request is received"** trigger
   - **Important**: Copy the HTTP POST URL from the trigger for your ACE configuration
   - Customize the response HTML content to match your requirements
   - Click **"Save"** and test the flow

### Flow Solution Details

The included flow solution (`ACEContentFlow_1_0_0_1.zip`) contains:

- âœ… **Pre-configured HTTP trigger** with proper JSON schema
- âœ… **Sample response template** with dynamic content
- âœ… **Error handling** for missing parameters
- âœ… **HTML formatting** optimized for ACE display
- âœ… **User context integration** (name, email, site info)
- âœ… **Prompt processing** for dynamic responses

### Expected JSON Schema

The flow is pre-configured to receive the following JSON payload from the ACE:

```json
{
    "type": "object",
    "properties": {
        "userId": {"type": "string"},
        "userEmail": {"type": "string"},
        "displayName": {"type": "string"},
        "siteUrl": {"type": "string"},
        "timestamp": {"type": "string"},
        "requestId": {"type": "string"},
        "tenantId": {"type": "string"},
        "prompt": {"type": "string"}
    }
}
```

### Customizing the Flow Response

After importing, you can customize the flow to:

- **Integrate with other services** (SharePoint lists, databases, APIs)
- **Add AI capabilities** (Azure OpenAI, AI Builder)
- **Include business logic** (approvals, calculations, data processing)
- **Connect to external systems** (CRM, ERP, third-party APIs)
- **Generate reports** (Power BI, Excel, custom dashboards)

### Example Flow Enhancements

```html
<!-- Example: AI-powered response using the prompt -->
<div style="font-family: Arial, sans-serif; padding: 20px;">
  <h2>ðŸ¤– AI Response</h2>
  <p><strong>Your Question:</strong> @{triggerBody()?['prompt']}</p>
  <p><strong>AI Answer:</strong> @{outputs('AI_Compose_Action')?['body']}</p>
  <hr>
  <small>Generated for @{triggerBody()?['displayName']} at @{triggerBody()?['timestamp']}</small>
</div>
```

### Testing Your Flow

1. **Use the built-in tester** in Power Automate
2. **Test with sample JSON**:
```json
{
  "userId": "test@domain.com",
  "userEmail": "test@domain.com",
  "displayName": "Test User",
  "siteUrl": "https://tenant.sharepoint.com/sites/test",
  "timestamp": "2025-09-17T10:00:00.000Z",
  "requestId": "test123",
  "tenantId": "test-tenant-id",
  "prompt": "Hello, how are you?"
}
```
3. **Verify HTML response** renders correctly
4. **Copy the HTTP URL** for ACE configuration

### Important Notes

- The solution import process may require you to **create or update connections** for any connectors used in the flow
- After import, the flow will be available in the **Solutions** area, not in **"My flows"**
- Make sure to **turn on the flow** after import if it's not automatically enabled
- The HTTP trigger URL will be different in your environment - always copy the URL from your imported flow
````
